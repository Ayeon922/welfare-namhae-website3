{% extends "base.html" %}

{% set show_progress = true %}
{% set current_step = 1 %}

{% block title %}1ë‹¨ê³„: ê¸°ë³¸ ì •ë³´ - ë…¸ì¸ ë³µì§€ ì¶”ì²œ í”Œë«í¼{% endblock %}

{% block content %}
<div class="survey-step">
    <div class="step-header">
        <h1 class="step-title">1ë‹¨ê³„: ê¸°ë³¸ ì •ë³´ ì…ë ¥</h1>
        <p class="step-description">ê°„ë‹¨í•œ ê¸°ë³¸ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. ëª¨ë“  ì •ë³´ëŠ” ì•ˆì „í•˜ê²Œ ë³´í˜¸ë©ë‹ˆë‹¤.</p>
    </div>
    
    <form id="step1-form" class="survey-form">
        <div class="form-section">
            <h2 class="section-title">ğŸ‘¤ ê°œì¸ ì •ë³´</h2>
            
            <div class="form-group">
                <label for="name" class="form-label">
                    ì„±í•¨ <span class="required">*</span>
                </label>
                <input 
                    type="text" 
                    id="name" 
                    name="name" 
                    class="form-input"
                    placeholder="ì˜ˆ: í™ê¸¸ë™"
                    required
                    aria-describedby="name-help"
                >
                <div id="name-help" class="form-help">
                    ğŸ’¡ ì„±í•¨ì€ ì¶”ì²œ ê²°ê³¼ì—ì„œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
                </div>
            </div>
            
            <div class="form-group">
                <label for="age" class="form-label">
                    ë‚˜ì´ <span class="required">*</span>
                </label>
                <input 
                    type="number" 
                    id="age" 
                    name="age" 
                    class="form-input"
                    placeholder="ì˜ˆ: 70"
                    min="60"
                    max="120"
                    required
                    aria-describedby="age-help"
                >
                <div id="age-help" class="form-help">
                    ğŸ’¡ ë§Œ ë‚˜ì´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
                </div>
            </div>
            
            <div class="form-group">
                <label for="birth_date" class="form-label">
                    ìƒë…„ì›”ì¼ <span class="required">*</span>
                </label>
                <input 
                    type="date" 
                    id="birth_date" 
                    name="birth_date" 
                    class="form-input"
                    required
                    aria-describedby="birth-help"
                >
                <div id="birth-help" class="form-help">
                    ğŸ’¡ ì •í™•í•œ ë³µì§€ í˜œíƒ í™•ì¸ì„ ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h2 class="section-title">ğŸ  ê±°ì£¼ ì •ë³´</h2>
            
            <div class="form-group">
                <label for="region" class="form-label">
                    ê±°ì£¼ ì§€ì—­ <span class="required">*</span>
                </label>
                <select 
                    id="region" 
                    name="region" 
                    class="form-select"
                    required
                    aria-describedby="region-help"
                >
                    <option value="">ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                    <option value="ì„œìš¸íŠ¹ë³„ì‹œ">ì„œìš¸íŠ¹ë³„ì‹œ</option>
                    <option value="ë¶€ì‚°ê´‘ì—­ì‹œ">ë¶€ì‚°ê´‘ì—­ì‹œ</option>
                    <option value="ëŒ€êµ¬ê´‘ì—­ì‹œ">ëŒ€êµ¬ê´‘ì—­ì‹œ</option>
                    <option value="ì¸ì²œê´‘ì—­ì‹œ">ì¸ì²œê´‘ì—­ì‹œ</option>
                    <option value="ê´‘ì£¼ê´‘ì—­ì‹œ">ê´‘ì£¼ê´‘ì—­ì‹œ</option>
                    <option value="ëŒ€ì „ê´‘ì—­ì‹œ">ëŒ€ì „ê´‘ì—­ì‹œ</option>
                    <option value="ìš¸ì‚°ê´‘ì—­ì‹œ">ìš¸ì‚°ê´‘ì—­ì‹œ</option>
                    <option value="ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ">ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ</option>
                    <option value="ê²½ê¸°ë„">ê²½ê¸°ë„</option>
                    <option value="ê°•ì›ë„">ê°•ì›ë„</option>
                    <option value="ì¶©ì²­ë¶ë„">ì¶©ì²­ë¶ë„</option>
                    <option value="ì¶©ì²­ë‚¨ë„">ì¶©ì²­ë‚¨ë„</option>
                    <option value="ì „ë¼ë¶ë„">ì „ë¼ë¶ë„</option>
                    <option value="ì „ë¼ë‚¨ë„">ì „ë¼ë‚¨ë„</option>
                    <option value="ê²½ìƒë¶ë„">ê²½ìƒë¶ë„</option>
                    <option value="ê²½ìƒë‚¨ë„">ê²½ìƒë‚¨ë„</option>
                    <option value="ì œì£¼íŠ¹ë³„ìì¹˜ë„">ì œì£¼íŠ¹ë³„ìì¹˜ë„</option>
                </select>
                <div id="region-help" class="form-help">
                    ğŸ’¡ ì§€ì—­ë³„ ë³µì§€ í”„ë¡œê·¸ë¨ ì¶”ì²œì„ ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.
                </div>
            </div>
            
            <div class="form-group">
                <label for="detailed_address" class="form-label">
                    ìƒì„¸ ì£¼ì†Œ (ì„ íƒ)
                </label>
                <input 
                    type="text" 
                    id="detailed_address" 
                    name="detailed_address" 
                    class="form-input"
                    placeholder="ì˜ˆ: ê°•ë‚¨êµ¬ ì—­ì‚¼ë™"
                    aria-describedby="address-help"
                >
                <div id="address-help" class="form-help">
                    ğŸ’¡ ì‹œ/êµ°/êµ¬ ë‹¨ìœ„ë¡œ ì…ë ¥í•˜ì‹œë©´ ë” ì •í™•í•œ ì¶”ì²œì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h2 class="section-title">ğŸ“ ì—°ë½ì²˜ (ì„ íƒ)</h2>
            
            <div class="form-group">
                <label for="phone" class="form-label">
                    ì—°ë½ì²˜ (ì„ íƒ)
                </label>
                <input 
                    type="tel" 
                    id="phone" 
                    name="phone" 
                    class="form-input"
                    placeholder="ì˜ˆ: 010-1234-5678"
                    aria-describedby="phone-help"
                >
                <div id="phone-help" class="form-help">
                    ğŸ’¡ ì¶”í›„ ë³µì§€ ê´€ë ¨ ì•ˆë‚´ë¥¼ ìœ„í•´ ì…ë ¥í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
            </div>
        </div>
        
        <div class="form-validation" id="form-validation" style="display: none;">
            <div class="validation-message error">
                <span class="validation-icon">âš ï¸</span>
                <span id="validation-text">í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="history.back()">
                â† ì´ì „ ë‹¨ê³„
            </button>
            <button type="submit" class="btn-primary" id="next-step-btn">
                ë‹¤ìŒ ë‹¨ê³„ â†’
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('step1-form');
    const validationDiv = document.getElementById('form-validation');
    const validationText = document.getElementById('validation-text');
    const nextBtn = document.getElementById('next-step-btn');
    
    // í¼ ë°ì´í„° ì €ì¥ (localStorage ì‚¬ìš©)
    function saveFormData() {
        const formData = new FormData(form);
        const data = {};
        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }
        localStorage.setItem('step1_data', JSON.stringify(data));
    }
    
    // ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    function loadFormData() {
        const savedData = localStorage.getItem('step1_data');
        if (savedData) {
            const data = JSON.parse(savedData);
            Object.keys(data).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) {
                    input.value = data[key];
                }
            });
        }
    }
    
    // ì‹¤ì‹œê°„ ìœ íš¨ì„± ê²€ì‚¬
    function validateForm() {
        const name = document.getElementById('name').value.trim();
        const age = document.getElementById('age').value;
        const birthDate = document.getElementById('birth_date').value;
        const region = document.getElementById('region').value;
        
        let isValid = true;
        let errorMessage = '';
        
        if (!name) {
            isValid = false;
            errorMessage = 'ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        } else if (!age || age < 60 || age > 120) {
            isValid = false;
            errorMessage = 'ë‚˜ì´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. (60ì„¸ ì´ìƒ)';
        } else if (!birthDate) {
            isValid = false;
            errorMessage = 'ìƒë…„ì›”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        } else if (!region) {
            isValid = false;
            errorMessage = 'ê±°ì£¼ ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
        }
        
        // ë‚˜ì´ì™€ ìƒë…„ì›”ì¼ ì¼ì¹˜ ì—¬ë¶€ í™•ì¸
        if (age && birthDate) {
            const birth = new Date(birthDate);
            const today = new Date();
            const calculatedAge = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                calculatedAge--;
            }
            
            if (Math.abs(calculatedAge - parseInt(age)) > 1) {
                isValid = false;
                errorMessage = 'ë‚˜ì´ì™€ ìƒë…„ì›”ì¼ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            }
        }
        
        if (!isValid) {
            validationDiv.style.display = 'block';
            validationText.textContent = errorMessage;
            nextBtn.disabled = true;
        } else {
            validationDiv.style.display = 'none';
            nextBtn.disabled = false;
        }
        
        return isValid;
    }
    
    // ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    form.addEventListener('input', function(e) {
        validateForm();
        saveFormData();
    });
    
    form.addEventListener('change', function(e) {
        validateForm();
        saveFormData();
    });
    
    // í¼ ì œì¶œ ì²˜ë¦¬
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (validateForm()) {
            // ìŒì„± ì•ˆë‚´
            if ('speechSynthesis' in window) {
                const msg = new SpeechSynthesisUtterance('ë‘ ë²ˆì§¸ ë‹¨ê³„ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                msg.lang = 'ko-KR';
                msg.rate = 0.8;
                speechSynthesis.speak(msg);
            }
            
            // ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
            window.location.href = "{{ url_for('survey_step2') }}";
        }
    });
    
    // ì ‘ê·¼ì„±: í‚¤ë³´ë“œ ë‚´ë¹„ê²Œì´ì…˜
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
            e.preventDefault();
            const inputs = Array.from(form.querySelectorAll('input, select'));
            const currentIndex = inputs.indexOf(e.target);
            
            if (currentIndex < inputs.length - 1) {
                inputs[currentIndex + 1].focus();
            } else {
                nextBtn.focus();
            }
        }
    });
    
    // ì´ˆê¸° ë¡œë“œ
    loadFormData();
    validateForm();
    
    // ì²« ë²ˆì§¸ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
    document.getElementById('name').focus();
});
</script>
{% endblock %} 